<!DOCTYPE html>
<html>
<head>
  <title>Viewing Screen ‚Äì Zyra View</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background: #fff;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      text-align: center;
      position: relative;
    }
    video {
      width: 90%;
      border: 2px solid #00C897;
      border-radius: 10px;
      margin-top: 20px;
    }
    #status {
      color: #198754;
      font-weight: bold;
      margin-top: 15px;
    }
    #laser-pointer {
      position: absolute;
      width: 20px;
      height: 20px;
      background: red;
      border-radius: 50%;
      pointer-events: none;
      mix-blend-mode: difference;
      display: none;
      z-index: 1000;
    }
    #control-button {
      margin-top: 20px;
    }
    #file-downloads {
      margin-top: 20px;
      text-align: left;
      max-width: 90%;
      margin-left: auto;
      margin-right: auto;
    }
  </style>
</head>
<body>
  <h2 class="text-success">Zyra View ‚Äì Viewing Remote Screen</h2>
  <p class="lead">üîê Connecting to session...</p>
  <p id="status">Waiting for screen sharer to connect...</p>
  <video id="stream" autoplay></video>

  <button id="control-button" class="btn btn-primary">Request Remote Control</button>

  <div id="file-downloads"></div>

  <div id="laser-pointer"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const roomId = window.location.pathname.split("/").pop();
    socket.emit("join-room", roomId);
    socket.emit("viewer-ready", roomId);

    const video = document.getElementById("stream");
    const mediaSource = new MediaSource();
    video.src = URL.createObjectURL(mediaSource);

    mediaSource.addEventListener("sourceopen", () => {
      const buffer = mediaSource.addSourceBuffer('video/webm; codecs="vp8"');
      socket.on("screen-stream", (data) => {
        const reader = new FileReader();
        reader.onload = () => buffer.appendBuffer(new Uint8Array(reader.result));
        reader.readAsArrayBuffer(data.chunk);
        document.getElementById("status").textContent = "‚úÖ Secure Session Active";
      });
    });

    // Laser pointer from sharer
    const laser = document.getElementById("laser-pointer");
    socket.on("laser", data => {
      laser.style.left = data.x + "px";
      laser.style.top = data.y + "px";
      laser.style.display = "block";
      clearTimeout(laser.hideTimeout);
      laser.hideTimeout = setTimeout(() => {
        laser.style.display = "none";
      }, 1000);
    });

    // Remote control request
    const controlBtn = document.getElementById("control-button");
    controlBtn.onclick = () => {
      socket.emit("control-request", { room: roomId, from: "Viewer" });
      controlBtn.disabled = true;
      controlBtn.textContent = "Control Requested...";
    };

    socket.on("control-granted", () => {
      document.getElementById("status").textContent = "üéâ Remote control granted!";

      // Setup control listeners
      video.addEventListener("mousemove", e => {
        socket.emit("mouse-event", {
          room: roomId,
          x: e.clientX,
          y: e.clientY
        });
      });

      window.addEventListener("keydown", e => {
        socket.emit("keyboard-event", {
          room: roomId,
          key: e.key,
          code: e.code
        });
      });
    });

    // File download handler
    socket.on("file-receive", data => {
      const downloads = document.getElementById("file-downloads");
      const a = document.createElement("a");
      a.href = data.content;
      a.download = data.name;
      a.textContent = `üì• ${data.name} (${Math.round(data.size/1024)} KB)`;
      a.style.display = "block";
      downloads.appendChild(a);
    });
  </script>
</body>
</html>
