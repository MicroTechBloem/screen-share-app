<!DOCTYPE html>
<html>
<head>
  <title>Sharing Screen ‚Äì Zyra View</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background: #f8f9fa;
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      padding: 20px;
    }
    #status {
      margin-top: 15px;
      font-weight: bold;
      color: #0d6efd;
    }
    video {
      max-width: 90%;
      border: 2px solid #0077cc;
      border-radius: 10px;
      margin-top: 20px;
    }
    #laser-pointer {
      position: absolute;
      width: 20px;
      height: 20px;
      background: red;
      border-radius: 50%;
      pointer-events: none;
      display: none;
      z-index: 1000;
      mix-blend-mode: difference;
    }
    #control-requests {
      margin-top: 20px;
    }
    #file-upload {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h2 class="text-primary">Zyra View ‚Äì Sharing Screen</h2>
  <p class="lead">Code: <span id="roomId"></span></p>
  <p id="status">üîê Establishing Secure Connection...</p>

  <video id="preview" autoplay muted></video>

  <div id="control-requests"></div>

  <input type="file" id="file-upload" />
  <button id="send-file-btn" disabled>Send File</button>

  <div id="laser-pointer"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const roomId = window.location.pathname.split("/").pop();
    document.getElementById("roomId").textContent = roomId;

    let connected = false;
    socket.emit("join-room", roomId);

    socket.on("viewer-ready", () => {
      connected = true;
      document.getElementById("status").textContent = "‚úÖ Secure Session Established";
      document.getElementById("send-file-btn").disabled = false;
    });

    // Control request UI
    socket.on("control-request", (data) => {
      const container = document.getElementById("control-requests");
      container.innerHTML = `
        <div class="alert alert-info">
          <strong>${data.from} wants control</strong>
          <button id="accept-control" class="btn btn-success btn-sm">Accept</button>
          <button id="deny-control" class="btn btn-danger btn-sm">Deny</button>
        </div>`;
      
      document.getElementById("accept-control").onclick = () => {
        socket.emit("control-granted", { room: roomId, to: data.from });
        container.innerHTML = "<p class='text-success'>Control granted.</p>";
      };
      document.getElementById("deny-control").onclick = () => {
        container.innerHTML = "<p class='text-danger'>Control denied.</p>";
      };
    });

    // Screen sharing setup
    navigator.mediaDevices.getDisplayMedia({ video: true }).then(stream => {
      document.getElementById("preview").srcObject = stream;
      const recorder = new MediaRecorder(stream);

      recorder.ondataavailable = e => {
        if (connected) {
          socket.emit("screen-stream", { room: roomId, chunk: e.data });
        }
      };
      recorder.start(200);
    });

    // Laser pointer
    socket.on("laser", data => {
      const laser = document.getElementById("laser-pointer");
      laser.style.left = data.x + "px";
      laser.style.top = data.y + "px";
      laser.style.display = "block";
      clearTimeout(laser.hideTimeout);
      laser.hideTimeout = setTimeout(() => {
        laser.style.display = "none";
      }, 1000);
    });

    // File sending
    const fileInput = document.getElementById("file-upload");
    const sendFileBtn = document.getElementById("send-file-btn");

    sendFileBtn.onclick = () => {
      if (!fileInput.files.length) return alert("Select a file first.");
      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = () => {
        socket.emit("file-send", {
          room: roomId,
          name: file.name,
          size: file.size,
          type: file.type,
          content: reader.result
        });
        alert("File sent.");
      };
      reader.readAsDataURL(file);
    };
  </script>
</body>
</html>
